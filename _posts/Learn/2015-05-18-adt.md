---
layout: post
title: "android之adt脚本打包"
categories: 编程
tags: android

---

mac下配置好adt的环境变量，在工程的根目录下执行build命令，生成工程的配置文件。具体操作网上都有，比我讲解地详细。

我主要是参考[简单的ant打包，修改渠道号](http://www.cnblogs.com/stay/archive/2013/05/27/3102027.html)这篇教程实现了修改versioncode和versionName，并且批量生成10个apk文件。

下面是相应地脚本文件，使用的话只用修改相应地路径即可。

若要修改其他的参数可以仿照检索“versionCode”关键字即可，前提是你的manifest文件里已经设置好了。

脚本修改好后在终端输入如下命令即可：

```
$ ant run
```



ant.properties

```
# This file is automatically generated by Android Tools.
# Do not modify this file -- YOUR CHANGES WILL BE ERASED!
#
# This file must be checked in Version Control Systems.
#
# To customize properties used by the Ant build system edit
# "ant.properties", and override values to adapt the script to your
# project structure.
#
# To enable ProGuard to shrink and obfuscate your code, uncomment this (available properties: sdk.dir, user.home):
#proguard.config=${sdk.dir}/tools/proguard/proguard-android.txt:proguard-project.txt


#编码方式
java.encoding=utf-8
#签名key文件绝对路径
key.store=/Users/username/Documents/Apk_fildes/keystore/mykeystore.keystore
#签名文件密码
key.store.password=123456789
#签名别称，中文的话需要转成utf-8编码，可以使用JDK自带的native2ascii工具
key.alias=mykeystore.keystore
#签名别称密码
key.alias.password=123456789
market_channels=00000
#设置app的版本（1.0.1）eg:version_code_1.version_code_2.app_version
version_code_1=1
version_code_2=0
app_version=0,1,2,3,4,5,6,7,8,9
#project name
project_name=MyTest
#project path
project_path=/Users/username/Documents/LUA/projects/proj.android
#project out path
project_out_path=/Users/username/Documents/Apk_fildes/keystore/out
```

local.properties

```
# This file is automatically generated by Android Tools.
# Do not modify this file -- YOUR CHANGES WILL BE ERASED!
#
# This file must *NOT* be checked into Version Control Systems,
# as it contains information specific to your local configuration.

# location of the SDK. This is only used by Ant
# For customization when using a Version Control System, please read the
# header note.
sdk.dir=/Users/username/Documents/adt/sdk
```

build.xml

```
<?xml version="1.0" encoding="UTF-8"?>
<project name="${project_name}" default="add">
    <property file="local.properties" />
    <property file="ant.properties" />
    <property environment="env" />
    <condition property="sdk.dir" value="${env.ANDROID_HOME}">
        <isset property="env.ANDROID_HOME" />
    </condition>
    <loadproperties srcFile="project.properties" />
    <fail
            message="sdk.dir is missing. Make sure to generate local.properties using 'android update project' or to inject it through the ANDROID_HOME environment variable."
            unless="sdk.dir"
    />
    <import file="custom_rules.xml" optional="true" />
    <import file="${sdk.dir}/tools/ant/build.xml" />

 <!--修改包名等-->
<!--相关环境及工具配置-->
 <property name="sdk.platformtools" value="${sdk.dir}/platform-tools" />
 <property name="sdk.tools" value="${sdk.dir}/tools" />
 <property name="aapt" value="${sdk.platformtools}/aapt" />
 <property name="adb" value="${sdk.platformtools}/adb" />
 <property name="dx" value="${sdk.platformtools}/dx" />
 <property name="apkbuilder" value="${sdk.tools}/apkbuilder" />
 <property name="android.jar" value="${sdk.dir}/platforms/android-17/android.jar" />

 <property name="old_package_name" value="com.example.travel" />
 <property name="new_package_name" value="com.zwtx.travel" />
 <property name="org_project.dir" value="${project_out_path}" />
 <!--原工程目录-->
 <property name="project.dir" value="${project_path}" />


 <!--新工程各个目录-->
 <property name="build.dir" value="${org_project.dir}/bin" />
 <property name="project.dir" value="${org_project.dir}/temp" />
 <!--新工程目录-->
 <property name="classes.dir" value="${project.dir}/bin/classes" />
 <property name="buildtemp.dir" value="${project.dir}/bin" />
 <property name="src.dir" value="${project.dir}/src" />
 <property name="res.dir" value="${project.dir}/res" />
 <property name="gen.dir" value="${project.dir}/gen" />
 <property name="asset.dir" value="${project.dir}/assets" />

 <taskdef resource="net/sf/antcontrib/antcontrib.properties">  
  <classpath>  
    <pathelement location="lib/ant-contrib-1.0b3.jar"/>  
  </classpath>  
</taskdef>  
 <target name="run">  
<!--    <foreach target="modify_manifest" list="${market_channels}" param="channel" delimiter=","> 
   </foreach>   -->
   <foreach target="modify_manifest" list="${app_version}" param="versioncode" delimiter=",">  
   </foreach>  
 </target>  

<target name="modify_manifest">  
  
  <echo>${channel}</echo>
  <echo>${versioncode}</echo>
<!-- 替换versionCode -->
  <replaceregexp flags="g" encoding="UTF-8" byline="true">
    <regexp pattern="android:versionCode(.*)"/>
     <substitution expression="android:versionCode=&quot;${versioncode}&quot;"/>
      <fileset dir="" includes="AndroidManifest.xml"/>
   </replaceregexp>
<!-- 替换versionName -->
  <replaceregexp flags="g" encoding="UTF-8" byline="true">
    <regexp pattern="android:versionName(.*)"/>
     <substitution expression="android:versionName=&quot;${version_code_1}.${versioncode}&quot;>"/>
      <fileset dir="" includes="AndroidManifest.xml"/>
   </replaceregexp>
  <property name="project_new">add</property>
  <property name="reasedAPK" value="${project_name}_v${version_code_1}.${versioncode}.apk" />
  <antcall target="add" />
</target>


 <target name="init">
  <echo> "Target init is called" </echo>
   <!--替换工程中出现的包名 -->
  <replaceregexp flags="g" encoding="UTF-8" byline="true">
    <regexp pattern="package(.*)${old_package_name}"/>
     <substitution expression="package=&quot;${new_package_name}"/>
      <fileset dir="${project.dir}" includes="AndroidManifest.xml"/>
   </replaceregexp>
<!--修改工程的package ****包名-->
  <replaceregexp flags="g" encoding="UTF-8" byline="true">
    <regexp pattern="package(.*)${old_package_name}"/>
     <substitution expression="package ${new_package_name}"/>
      <fileset dir="${project.dir}/src" includes="**/*.java"/>
   </replaceregexp>
<!--修改工程的import ****.R包名-->
  <replaceregexp flags="g" encoding="UTF-8" byline="true">
    <regexp pattern="import(.*)${old_package_name}.R"/>
     <substitution expression="import ${new_package_name}.R"/>
      <fileset dir="${project.dir}/src" includes="**/*.java"/>
   </replaceregexp>
  </target>


  <!--生成R.java文件 ${sdk.dir}\platform-tools\aapt.exe-->
  <target name="genRJava">
    <echo> "Target genRJava is called" </echo>
    <exec executable="/Users/xunzhou/Documents/adt/sdk/platform-tools/aapt" failonerror="true">
      <arg value="package"/>
      <arg value="-m"/>
      <arg value="-J"/>
      <arg value="${project.dir}/gen"/>
      <arg value="-M"/>
      <arg value="${project.dir}/AndroidManifest.xml"/>
      <arg value="-S"/>
      <arg value="${res.dir}"/>
      <arg value="-I"/>
      <arg value="${android.jar}"/>
    </exec>
  </target>
  <!-- 项目编译 -->
  <target name="compile" >
    <echo> "Target compile is called" </echo>
    <javac encoding="UTF-8" target="1.5" debug="true" extdirs="" 
     srcdir="${gen.dir};${src.dir}" 
     destdir="${classes.dir}" bootclasspath="${android.jar}">
      <classpath>
        <fileset dir="${project.dir}/libs" includes="*.jar">
        </fileset>
      </classpath>
    </javac>
  </target>
<!-- 生成dex文件 ${sdk.dir}\platform-tools\dx.bat -->
  <target name="dex" >
    <echo> "Target dex is called" </echo>
    <apply executable="${sdk.dir}/platform-tools/dx" failonerror="true" parallel="true">
      <arg value="--dex"/>
      <arg value="--output=${buildtemp.dir}/classes.dex"/>
      <arg path="${classes.dir}"/>
      <fileset dir="${project.dir}/libs" includes="*.jar"/>
    </apply>
  </target>

 <!-- 打包资源文件 ${sdk.dir}\platform-tools\aapt.exe -->
  <target name="packageRes">
    <echo> "Target packageRes is called" </echo>
    <exec executable="${aapt}" failonerror="true">
      <arg value="package"/>
      <arg value="-f"/>
      <arg value="-M"/>
      <arg value="${project.dir}/AndroidManifest.xml"/>
      <arg value="-S"/>
      <arg value="${res.dir}"/>
      <arg value="-A"/>
      <arg value="${asset.dir}"/>
      <arg value="-I"/>
      <arg value="${android.jar}"/>
      <arg value="-F"/>
      <arg value="${buildtemp.dir}/resources.ap_"/>
    </exec>
  </target>

 <!-- 打包Apk -->
  <target name="add" depends="init,genRJava,compile,dex,packageRes">
    <echo> "Target add is called" </echo>
    <exec executable="${apkbuilder}" failonerror="true">
      <arg value="${buildtemp.dir}/unsigntest.apk"/>
      <arg value="-u"/>
      <arg value="-z"/>
      <arg value="${buildtemp.dir}/resources.ap_"/>
      <arg value="-f"/>
      <arg value="${buildtemp.dir}/classes.dex"/>
      <arg value="-rf"/>
      <arg value="${src.dir}"/>
      <!--打包.jar文件-->
      <arg value="-rj"/>
      <arg value="${project.dir}/libs"/>
      <!--打包.so文件-->
      <arg value="-nf"/>
      <arg value="${project.dir}/libs"/>
    </exec>
    <!-- 签名 -->
  <signjar
     jar="${buildtemp.dir}/unsigntest.apk"
     signedjar="${project_out_path}/${reasedAPK}"
     keystore="${key.store}"
     storepass="${key.store.password}"
     alias="${key.alias}"
     keypass="${key.alias.password}"
     verbose="-verbose"/>
   </target>

</project>
```

[配置文件下载](http://pan.baidu.com/s/1sjzBK0d)
